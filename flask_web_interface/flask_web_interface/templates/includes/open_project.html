{% extends 'layouts/base.html' %}

{% block main %}

<div class="container-fluid px-4">
  <h1 class="mt-4">{{ data.project.name }}</h1>
  <ol class="breadcrumb mb-4">
    <li class="breadcrumb-item active">{{ data.project.name }}</li>
  </ol>

  <!-- Tabs Navigation -->
  <ul class="nav nav-tabs" id="configTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="config-a-tab" data-bs-toggle="tab" data-bs-target="#config-a" type="button" role="tab" aria-controls="config-a" aria-selected="true">
        Project Configuration
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="config-b-tab" data-bs-toggle="tab" data-bs-target="#config-b" type="button" role="tab" aria-controls="config-b" aria-selected="false">
        Output Images
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3" id="configTabsContent">

    <!-- === Tab 1: Project Configuration (Update) === -->
    <div class="tab-pane fade show active" id="config-a" role="tabpanel" aria-labelledby="config-a-tab">

      <form id="update-form" action="{{ url_for('web.update_project') }}" method="POST" enctype="multipart/form-data">
        <!-- wichtig: slug mitsenden, damit wir wissen, welches Projekt upzudaten ist -->
        <input type="hidden" name="slug" value="{{ data.project.slug }}">

        <div class="card mb-4">
          <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Project Configuration
          </div>

          <!-- Projektname (nur Anzeige oder editierbar – hier editierbar; das Umbenennen des Slugs behandeln wir in der Route NICHT) -->
          <div class="card-body mt-0 mb-0">
            <label for="projectName" class="form-label">Projektname</label>
            <input type="text" class="form-control" id="projectName" name="projectName"
                   value="{{ data.project.name }}" placeholder="Project Name">
            <small class="text-muted">Hinweis: Das Umbenennen ändert hier NICHT automatisch den Slug/Pfad.</small>
          </div>

          <!-- Upload mit Button & Fortschritt -->
          <div class="card-body mt-2 mb-2">
            <label for="images" class="form-label">Upload Images (optional, ergänzt bestehende Liste)</label>
            <div class="d-flex gap-2">
              <input type="file" class="form-control" id="images" name="images" multiple>
              <button type="button" id="btn-upload" class="btn btn-outline-primary">Upload</button>
            </div>

            <!-- Progressbar -->
            <div class="progress mt-2" style="height: 22px; display:none;" id="upload-progress-wrap">
              <div class="progress-bar" role="progressbar" id="upload-progress" style="width: 0%">0%</div>
            </div>

            <small class="text-muted d-block mt-2">
              Optionaler Vorab-Upload mit Fortschrittsanzeige. Du kannst auch ohne „Upload“ direkt speichern (ohne Fortschrittsanzeige).
            </small>

            <!-- Bereits vorhandene Bilder -->
            {% if data.paths.images %}
              <div class="mt-3">
                <div class="fw-semibold mb-1">Bereits im Projekt:</div>
                <ul class="mb-0">
                  {% for path in data.paths.images %}
                    <li>{{ path.replace('\\', '/') }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}

            <!-- Liste neu hochgeladener Dateien (temp) -->
            <ul class="mt-2" id="uploaded-list" style="display:none;"></ul>

            <!-- Hidden: upload_id + serverseitig gespeicherte Pfade -->
            <input type="hidden" name="upload_id" id="upload_id">
            <textarea name="uploaded_paths" id="uploaded_paths" hidden></textarea>
          </div>

          <!-- Parameter -->
          <div class="card-body mt-2 mb-2">
            <label for="LaplaceFilterSize" class="form-label">Laplace Filter Size</label>
            <input type="number" class="form-control" id="LaplaceFilterSize" name="LaplaceFilterSize"
                   value="{{ data.params.LaplaceFilterSize }}" min="1" max="100">
          </div>

          <div class="card-body mt-2 mb-2">
            <label for="NumberofImagesinPyramid" class="form-label">Number of Images in Pyramid</label>
            <input type="number" class="form-control" id="NumberofImagesinPyramid" name="NumberofImagesinPyramid"
                   value="{{ data.params.NumberofImagesinPyramid or 1 }}" min="1" max="100">
          </div>

          <div class="card-body mt-2 mb-2">
            <label for="PatchSizeX" class="form-label">Patch-Size Sharpness: X</label>
            <input type="number" class="form-control" id="PatchSizeX" name="PatchSizeX"
                   value="{{ data.params.PatchSizeX or 3 }}" min="1" max="100">
          </div>

          <div class="card-body mt-2 mb-2">
            <label for="PatchSizeY" class="form-label">Patch-Size Sharpness: Y</label>
            <input type="number" class="form-control" id="PatchSizeY" name="PatchSizeY"
                   value="{{ data.params.PatchSizeY or 3 }}" min="1" max="100">
          </div>

          <div class="card-body mt-2 mb-2">
            <label for="ImgResize" class="form-label">Image Resize</label>
            <input type="number" class="form-control" id="ImgResize" name="ImgResize"
                   value="{{ data.params.ImgResize or 100 }}" min="0.01" max="100" step="0.01">
          </div>

          <div class="card-body mt-2 mb-2">
            <label for="z_spacing" class="form-label">Z-Spacing</label>
            <input type="number" class="form-control" id="z_spacing" name="z_spacing"
                   value="{{ data.params.z_spacing or 1 }}" min="0" max="100" step="0.01">
          </div>

          <div class="card-body mt-2 mb-2 text-end">
            <a href="{{ url_for('web.index') }}" class="btn btn-secondary">Abbrechen</a>
            <button type="submit" class="btn btn-primary" name="action" value="update">Save Changes</button>
            <button type="submit" class="btn btn-primary" name="action" value="update_run">Save &amp; Run</button>
          </div>
        </div>
      </form>
    </div>
<!-- === Tab 2: Output Images === -->
<div class="tab-pane fade" id="config-b" role="tabpanel" aria-labelledby="config-b-tab">
  {% set slug = (data.project.slug or data.project.name) %}
  {% set sharp_name = (data.paths.output_sharp or '').split('/')[-1] %}
  {% set depth_jpg  = (data.paths.output_depth or '').split('/')[-1] %}
  {% set depth_exr  = (data.paths.output_exr  or '') %}

  {# Fallbacks, falls YAML noch leer ist #}
  {% if not sharp_name %}{% set sharp_name = slug ~ '_sharpness.jpg' %}{% endif %}
  {% if not depth_jpg %}{% set depth_jpg = slug ~ '_depth.jpg' %}{% endif %}

  {# exr: bevorzugt aus output_exr, sonst aus output_depth den Stem nehmen #}
  {% if depth_exr %}
    {% set exr_name = depth_exr.split('/')[-1] %}
  {% else %}
    {% set stem = depth_jpg.rsplit('.', 1)[0] %}
    {% set exr_name = stem ~ '.exr' %}
  {% endif %}


  {% if exist %}
  <div class="card mb-4">
    <div class="card-header">
      <i class="fas fa-table me-1"></i>
      Project Output Images
    </div>

    <div class="container mt-4">
      <div class="row">

        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card">
            <img src="{{ url_for('web.serve_image', slug=slug, filename=sharp_name, send='False') }}" alt="Sharpness" class="img-fluid">
            <div class="card-body text-center">
              <a href="{{ url_for('web.serve_image', slug=slug, filename=sharp_name, send='True') }}" download>Download</a>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card">
            <img src="{{ url_for('web.serve_image', slug=slug, filename=depth_jpg, send='False') }}" alt="Depth" class="img-fluid">
            <div class="card-body text-center">
              <a href="{{ url_for('web.serve_image', slug=slug, filename=depth_jpg, send='True') }}" download>Download</a>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card">
            <img src="{{ url_for('web.serve_image', slug=slug, filename=exr_name, send='False') }}" alt="Depth EXR" class="img-fluid">
            <div class="card-body text-center">
              <a href="{{ url_for('web.serve_image', slug=slug, filename=exr_name, send='True') }}" download>Download EXR</a>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
  {% else %}
    <div class="alert alert-warning mt-4" role="alert">
      No Images Found
    </div>
  {% endif %}
</div>

  </div>
</div>

<!-- Upload mit XHR (Fortschritt) -->
<script>
(function () {
  const input    = document.getElementById('images');
  const btn      = document.getElementById('btn-upload');
  const wrap     = document.getElementById('upload-progress-wrap');
  const bar      = document.getElementById('upload-progress');
  const list     = document.getElementById('uploaded-list');
  const hiddenId = document.getElementById('upload_id');
  const hiddenPaths = document.getElementById('uploaded_paths');

  function uuid() {
    return 'xxxxxxxyxxxx'.replace(/[xy]/g, c => {
      const r = Math.random()*16|0, v = c === 'x' ? r : (r&0x3|0x8);
      return v.toString(16);
    });
  }

  btn.addEventListener('click', function () {
    const files = input.files;
    if (!files || files.length === 0) {
      alert('Bitte zuerst Dateien auswählen.');
      return;
    }

    if (!hiddenId.value) hiddenId.value = uuid();

    const formData = new FormData();
    formData.append('upload_id', hiddenId.value);
    for (let i = 0; i < files.length; i++) {
      formData.append('images', files[i]);
    }

    btn.disabled = true;
    wrap.style.display = 'block';
    bar.style.width = '0%';
    bar.textContent = '0%';

    const xhr = new XMLHttpRequest();
    xhr.open('POST', '{{ url_for("web.upload_temp") }}', true);

    xhr.upload.onprogress = function (e) {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        bar.style.width = percent + '%';
        bar.textContent = percent + '%';
      }
    };
    xhr.onerror = function () {
      alert('Upload fehlgeschlagen.');
      btn.disabled = false;
    };
    xhr.onload = function () {
      btn.disabled = false;
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          const resp = JSON.parse(xhr.responseText);
          if (resp && resp.paths) {
            hiddenPaths.value = JSON.stringify(resp.paths);
            list.innerHTML = '';
            resp.paths.forEach(p => {
              const li = document.createElement('li');
              li.textContent = p;
              list.appendChild(li);
            });
            list.style.display = 'block';
            input.value = ''; // optional: Auswahl leeren
          } else {
            alert('Server-Antwort ungültig.');
          }
        } catch (e) {
          alert('Antwort konnte nicht gelesen werden.');
        }
      } else {
        alert('Upload fehlgeschlagen (HTTP ' + xhr.status + ').');
      }
    };

    xhr.send(formData);
  });
})();
</script>

{% endblock %}
